# 聊天服

Chat 是 Cinder 框架下的聊天服务器。
设计为一个游戏区开一个Chat进程。
单区在线人数设计为 10 万人之内，聊天群规模小，聊天频率极低，以"不休的乌拉拉"为参照。

未来若是负载要求变高，可以在此基础上再设计水平扩展。

聊天服为服务器内部服，客户端不知道有聊天服存在。聊天服的服务对象是其他服务器，如Game服或Space服。
这些服通过 chatapi 来操作聊天服。详见：[chatapi/chat_usage_md](chatapi/chat_usage.md)

代码覆盖测试说明见：[coverage_test/README.md](coverage_test/README.md)

## 设计

MongoDB 集合设计见：[doc/mongodb_design.md](doc/mongodb_design.md)

### 预加载玩家的所有群

目前实现为玩家上线时，加载其所有群。
如果群是按需加载，如待到请求群离线消息，或者群聊天时再加载，设计会复杂点。
此时User还没加入UserMgr，注意群的在线玩家列表需要在并发的情况下正确初始化。

### 防死锁

曾发现一个死锁，同意加好友回调会死锁，造成 rpc 总是超时：
加好友同意时，回调battle服 RPC_AddFriendRet，
而 battle 服在回调中阻塞式向 chat 服查询好友信息，而 chat 服正阻塞式等待回调返回，两者都需要同一玩家的锁。

为避免这种死锁，回调执行时不要加锁。当前RPC请求应该尽快返回并释放锁，所有回调都应该在协程中执行。

## Todo

* [x] 定义 UserID 类型和 GroupID 类型
* [x] 最后一人离开群后解散群
	+ 无需特别处理，群成员为空和群删除在 mongodb 中是一样的
		- 仅离线消息未删，这个可以忽略
* [ ] 同一服务器的消息合并成一个，减少消息个数
	- 服务器有个消息队列，延时发送
	- 参见 Matcher 服
